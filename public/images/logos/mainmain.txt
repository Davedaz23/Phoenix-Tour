import 'dart:async';
import 'dart:developer';
import 'package:agent_app/pages/initial_agent.dart';
import 'package:agent_app/pages/security_screens.dart';
import 'package:agent_app/pages/warning_screen.dart';
import 'package:agent_app/services/lifecycle_manager.dart';
import 'package:agent_app/state/dataprovide_agent.dart';
import 'package:easy_localization/easy_localization.dart';
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_dotenv/flutter_dotenv.dart';
import 'package:provider/provider.dart';
import 'package:freerasp/freerasp.dart';
import 'package:root_checker_plus/root_checker_plus.dart';
import 'package:shared_preferences/shared_preferences.dart';

void main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // Initialize environment first
  await dotenv.load(fileName: ".env");

  // Show loading screen immediately
  runApp(const SecurityCheckApp());

  // Setup FreeRASP and check for violations
  final violationResult = await _setupAndCheckFreeRASP();

  if (violationResult.hasViolation) {
    await _showSecurityViolationAndExit(violationResult.violationType);
    return;
  }

  await _startMainApp();
}

// Security check app that shows loading screen
class SecurityCheckApp extends StatelessWidget {
  const SecurityCheckApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp(
      debugShowCheckedModeBanner: false,
      home: Scaffold(
        backgroundColor: Colors.white,
        body: Container(
          decoration: const BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topLeft,
              end: Alignment.bottomRight,
              colors: [
                Color.fromARGB(255, 157, 85, 202), // Deep Purple
                Color.fromARGB(255, 206, 144, 218), // Lavender
                Colors.black, // Magenta Pink
              ],
            ),
          ),
          child: Center(
            child: Column(
              mainAxisSize: MainAxisSize.min,
              children: [
                Image.asset(
                  "assets/cbe.jpg",
                  height: 70,
                  width: 70,
                  fit: BoxFit.cover,
                ),
                SizedBox(height: 20),
                Text(
                  ' CBEBirr Agent App',
                  style: TextStyle(
                    color: Colors.white,
                    fontSize: 20,
                    fontWeight: FontWeight.bold,
                    letterSpacing: 2,
                    shadows: [
                      Shadow(offset: Offset(0.5, 0), color: Colors.deepPurple),
                      Shadow(offset: Offset(-0.5, 0), color: Colors.grey),
                    ],
                  ),
                ),
                SizedBox(height: 10),
                SizedBox(height: 55),
                CircularProgressIndicator(
                  valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                )
              ],
            ),
          ),
        ),
      ),
    );
  }
}

// Create a simple data class to hold violation info
class ViolationResult {
  final bool hasViolation;
  final String violationType;
  final List<SecurityViolation> violations;

  ViolationResult({
    required this.hasViolation,
    required this.violationType,
    this.violations = const [],
  });
}

Future<ViolationResult> _setupAndCheckFreeRASP() async {
  final completer = Completer<ViolationResult>();
  final List<String> detectedViolations = [];
  String primaryViolation = 'Security violation detected';

  final callback = ThreatCallback(
    onPrivilegedAccess: () {
      detectedViolations.add('privileged_access');
      primaryViolation = 'Root/Jailbreak detected';
      if (!completer.isCompleted) {
        completer.complete(ViolationResult(
          hasViolation: true,
          violationType: primaryViolation,
          violations: ViolationDatabase.getViolations(detectedViolations),
        ));
      }
    },

    onDevMode: () {
      detectedViolations.add('dev_mode');
      primaryViolation = 'Developer mode is enabled';
      if (!completer.isCompleted) {
        completer.complete(ViolationResult(
          hasViolation: true,
          violationType: primaryViolation,
          violations: ViolationDatabase.getViolations(detectedViolations),
        ));
      }
    },

    // onAppIntegrity: () {
    //   detectedViolations.add('app_integrity');
    //   primaryViolation = 'App integrity compromised (tampering detected)';
    //   if (!completer.isCompleted) {
    //     completer.complete(ViolationResult(
    //       hasViolation: true,
    //       violationType: primaryViolation,
    //       violations: ViolationDatabase.getViolations(detectedViolations),
    //     ));
    //   }
    // },

    // onSecureHardwareNotAvailable: () {
    //   detectedViolations.add('secure_hardware');
    //   primaryViolation = 'Secure hardware not available';
    //   if (!completer.isCompleted) {
    //     completer.complete(ViolationResult(
    //       hasViolation: true,
    //       violationType: primaryViolation,
    //       violations: ViolationDatabase.getViolations(detectedViolations),
    //     ));
    //   }
    // },
    //   onObfuscationIssues: () {
    //     detectedViolations.add('obfuscation');
    //     primaryViolation = 'Code obfuscation issues';
    //     if (!completer.isCompleted) {
    //       completer.complete(ViolationResult(
    //         hasViolation: true,
    //         violationType: primaryViolation,
    //         violations: ViolationDatabase.getViolations(detectedViolations),
    //       ));
    //     }
    //   },
  );

  try {
    var config = TalsecConfig(
      androidConfig: AndroidConfig(
        supportedStores: ['com.android.vending'],
        packageName: 'com.agentapp.agent_app',
        signingCertHashes: ['TtBkCresNB0x9gg2YREmjq7YQdbB2Mu8t2b2evQPLtY='],
      ),
      watcherMail: 'raheldemissie56@gmail.com',
    );

    await Talsec.instance.start(config);
    Talsec.instance.attachListener(callback);

    // Wait longer for initial detection to ensure complete check
    await Future.delayed(const Duration(seconds: 3));

    if (!completer.isCompleted) {
      completer.complete(ViolationResult(
        hasViolation: detectedViolations.isNotEmpty,
        violationType: detectedViolations.isNotEmpty
            ? primaryViolation
            : 'No violation detected',
        violations: ViolationDatabase.getViolations(detectedViolations),
      ));
    }
  } catch (e) {
    if (!completer.isCompleted) {
      completer.complete(ViolationResult(
        hasViolation: false,
        violationType: 'Error during security check: $e',
        violations: [],
      ));
    }
  }

  return completer.future;
}

Future<void> _showSecurityViolationAndExit(String message) async {
  final prefs = await SharedPreferences.getInstance();
  await prefs.setBool('security_violation', true);
  await prefs.setString('violation_reason', message);

  // Use the exact same implementation as before
  runApp(MaterialApp(
    home: Scaffold(
      backgroundColor: Colors.red[50],
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Colors.red[50]!,
              Colors.red[100]!,
              Colors.white,
            ],
          ),
        ),
        child: Center(
          child: SingleChildScrollView(
            child: Padding(
              padding: const EdgeInsets.all(24.0),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  Container(
                    width: 120,
                    height: 120,
                    decoration: BoxDecoration(
                      color: Colors.red[100],
                      shape: BoxShape.circle,
                      border: Border.all(
                        color: Colors.red,
                        width: 3,
                      ),
                    ),
                    child: Icon(
                      Icons.security,
                      size: 60,
                      color: Colors.red[700],
                    ),
                  ),
                  const SizedBox(height: 32),
                  Text(
                    'Security Alert',
                    style: TextStyle(
                      fontSize: 28,
                      fontWeight: FontWeight.bold,
                      color: Colors.red[800],
                      letterSpacing: 1.2,
                    ),
                    textAlign: TextAlign.center,
                  ),
                  const SizedBox(height: 24),
                  Container(
                    width: double.infinity,
                    padding: const EdgeInsets.all(20),
                    decoration: BoxDecoration(
                      color: Colors.white,
                      borderRadius: BorderRadius.circular(16),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.red.withOpacity(0.1),
                          blurRadius: 10,
                          offset: const Offset(0, 4),
                        ),
                      ],
                      border: Border.all(
                        color: Colors.red[200]!,
                        width: 1,
                      ),
                    ),
                    child: Column(
                      children: [
                        Icon(
                          Icons.warning_amber_rounded,
                          size: 40,
                          color: Colors.orange[700],
                        ),
                        const SizedBox(height: 16),
                        Text(
                          message,
                          style: const TextStyle(
                            fontSize: 16,
                            fontWeight: FontWeight.w500,
                            color: Colors.black87,
                            height: 1.5,
                          ),
                          textAlign: TextAlign.center,
                        ),
                        const SizedBox(height: 8),
                        Text(
                          'This app cannot run in this environment for security reasons.',
                          style: TextStyle(
                            fontSize: 14,
                            color: Colors.grey[700],
                            height: 1.4,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ],
                    ),
                  ),
                  const SizedBox(height: 32),
                  Container(
                    width: double.infinity,
                    height: 54,
                    decoration: BoxDecoration(
                      gradient: LinearGradient(
                        colors: [
                          Colors.red[600]!,
                          Colors.red[800]!,
                        ],
                        begin: Alignment.centerLeft,
                        end: Alignment.centerRight,
                      ),
                      borderRadius: BorderRadius.circular(12),
                      boxShadow: [
                        BoxShadow(
                          color: Colors.red.withOpacity(0.3),
                          blurRadius: 8,
                          offset: const Offset(0, 4),
                        ),
                      ],
                    ),
                    child: Material(
                      color: Colors.transparent,
                      child: InkWell(
                        borderRadius: BorderRadius.circular(12),
                        onTap: () {
                          SystemNavigator.pop();
                        },
                        child: const Center(
                          child: Row(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Icon(
                                Icons.exit_to_app,
                                color: Colors.white,
                                size: 20,
                              ),
                              SizedBox(width: 8),
                              Text(
                                'Exit Application',
                                style: TextStyle(
                                  fontSize: 18,
                                  fontWeight: FontWeight.w600,
                                  color: Colors.white,
                                  letterSpacing: 1.1,
                                ),
                              ),
                            ],
                          ),
                        ),
                      ),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    ),
  ));

  // Auto exit after 5 seconds
  Timer(const Duration(seconds: 5), () {
    SystemNavigator.pop();
  });
}

Future<void> _startMainApp() async {
  await handleAppStartup();

  WidgetsBinding.instance.addObserver(AppLifecycleManager());
  await EasyLocalization.ensureInitialized();

  SystemChrome.setPreferredOrientations([DeviceOrientation.portraitUp])
      .then((_) {
    runApp(EasyLocalization(
      supportedLocales: const [Locale('am'), Locale('en')],
      path: 'assets/translations',
      child: MultiProvider(
        providers: [
          ChangeNotifierProvider(create: (context) => DataProvider()),
          ChangeNotifierProvider(create: (context) => LanguageProvider()),
        ],
        child: const SecureAppWrapper(),
      ),
    ));
  });
}

// Wrapper that ensures security is continuously monitored
class SecureAppWrapper extends StatefulWidget {
  const SecureAppWrapper({super.key});

  @override
  State<SecureAppWrapper> createState() => _SecureAppWrapperState();
}

class _SecureAppWrapperState extends State<SecureAppWrapper> {
  SecurityState _securityState = SecurityState.checking;
  late SharedPreferences _prefs;
  String? _violationType;
  bool _initialCheckComplete = false;
  List<SecurityViolation> _detectedViolations = [];

  @override
  void initState() {
    super.initState();
    _checkRootStatus();
    _initializeSecurity();
  }

  bool root = false;

  Future<void> _checkRootStatus() async {
    try {
      bool? isRooted = await RootCheckerPlus.isRootChecker();
      bool? isdeveloper = await RootCheckerPlus.isDeveloperMode();
      if (isRooted! || isdeveloper!) {
        setState(() {
          root = true;
        });
        // Future.delayed(Duration.zero, () {
        //   SystemNavigator.pop(); //  exit the app
        // });
      }
    } on PlatformException catch (e) {
      SystemNavigator.pop(); // exit the app
    }
  }

  Future<void> _initializeSecurity() async {
    await _initPreferences();

    // Perform initial security check
    await _performInitialSecurityCheck();

    // Setup runtime monitoring
    _setupFreeRASPRuntime();

    setState(() {
      _initialCheckComplete = true;
    });
  }

  Future<void> _initPreferences() async {
    _prefs = await SharedPreferences.getInstance();
  }

  Future<void> _performInitialSecurityCheck() async {
    // Check for previous security violations
    final hasViolation = _prefs.getBool('security_violation') ?? false;
    final violationReason = _prefs.getString('violation_reason');

    if (hasViolation) {
      // Convert stored violation reason to SecurityViolation objects
      _detectedViolations = _convertStoredViolationToObjects(violationReason);
      setState(() {
        _securityState = SecurityState.violation;
        _violationType = violationReason;
      });
      return;
    }

    // Additional delay to ensure thorough check
    await Future.delayed(const Duration(seconds: 1));

    // Final security check
    final currentViolation = _prefs.getBool('security_violation') ?? false;
    final currentViolationReason = _prefs.getString('violation_reason');

    setState(() {
      _securityState =
          currentViolation ? SecurityState.violation : SecurityState.secure;
      _violationType = currentViolationReason;
      _detectedViolations =
          _convertStoredViolationToObjects(currentViolationReason);
    });
  }

  List<SecurityViolation> _convertStoredViolationToObjects(
      String? violationReason) {
    if (violationReason == null) return [];

    // This is a simplified conversion - you might want to store violation types more systematically
    for (final violation in ViolationDatabase.violations.values) {
      if (violationReason
              .toLowerCase()
              .contains(violation.type.toLowerCase()) ||
          violationReason
              .toLowerCase()
              .contains(violation.title.toLowerCase())) {
        return [violation];
      }
    }

    // Default violation if no specific match
    return [];
  }

  void _setupFreeRASPRuntime() {
    final callback = ThreatCallback(onPrivilegedAccess: () {
      clearStorage(); //clear data if device is rooted!
      _handleSecurityViolation('Root/Jailbreak detected', 'privileged_access');
    }, onDevMode: () {
      //  clearStorage();
      _handleSecurityViolation('Developer mode is enabled', 'dev_mode');
    });

    Talsec.instance.attachListener(callback);
  }

  Future<void> clearStorage() async {
    await storage.deleteAll();
  }

  Future<void> _handleSecurityViolation(
      String violationType, String violationKey) async {
    // Save violation state persistently
    await _prefs.setBool('security_violation', true);
    await _prefs.setString('violation_reason', violationType);

    // Add to detected violations
    final violation = ViolationDatabase.getViolation(violationKey);
    if (violation != null &&
        !_detectedViolations.any((v) => v.type == violationKey)) {
      _detectedViolations.add(violation);
    }

    if (mounted) {
      setState(() {
        _securityState = SecurityState.violation;
        _violationType = violationType;
      });
    }
  }

  @override
  Widget build(BuildContext context) {
    // Don't show main app until initial security check is complete
    if (!_initialCheckComplete) {
      return MaterialApp(
        debugShowCheckedModeBanner: false,
        home: _buildLoadingScreen(),
      );
    }

    return MaterialApp(
      debugShowCheckedModeBanner: false,
      title: 'CBEBirr Agent App',
      localizationsDelegates: context.localizationDelegates,
      supportedLocales: context.supportedLocales,
      locale: context.locale,
      theme: ThemeData(
        colorScheme: ColorScheme.fromSeed(seedColor: Colors.deepPurple),
        useMaterial3: true,
      ),
      home: _buildCurrentScreen(),
    );
  }

  Widget _buildCurrentScreen() {
    switch (_securityState) {
      case SecurityState.checking:
        return _buildLoadingScreen();
      case SecurityState.violation:
        return EnhancedWarningScreen(
          violations: _detectedViolations,
          primaryViolation: _violationType,
        );
      case SecurityState.secure:
        return root ? WarningScreen() : Initial();
    }
  }

  Widget _buildLoadingScreen() {
    return Scaffold(
      body: Container(
        decoration: const BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topLeft,
            end: Alignment.bottomRight,
            colors: [
              Color.fromARGB(255, 157, 85, 202), // Deep Purple
              Color.fromARGB(255, 206, 144, 218), // Lavender
              Colors.black, // Magenta Pink
            ],
          ),
        ),
        child: Center(
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Image.asset(
                "assets/cbe.jpg",
                height: 70,
                width: 70,
                fit: BoxFit.cover,
              ),
              SizedBox(height: 20),
              const Text(
                'CBEBirr Agent App',
                style: TextStyle(
                  color: Colors.white,
                  fontSize: 20,
                  fontWeight: FontWeight.bold,
                  letterSpacing: 2,
                  shadows: [
                    Shadow(offset: Offset(0.5, 0), color: Colors.deepPurple),
                    Shadow(offset: Offset(-0.5, 0), color: Colors.grey),
                  ],
                ),
              ),
              SizedBox(height: 10),
              SizedBox(height: 55),
              CircularProgressIndicator(
                valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
              )
            ],
          ),
        ),
      ),
    );
  }
}

enum SecurityState {
  checking,
  violation,
  secure,
}

Future<void> handleAppStartup() async {
  await Future.delayed(const Duration(milliseconds: 500));
}
